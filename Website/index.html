<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Westley Kleinman ‚Ä¢ Engineer & Designer</title>  <meta name="description" content="Personal website of Westley Kleinman - Duke engineering student, competitive cyclist, and founder of Elevon custom 3D trail maps." />
  <link rel="stylesheet" href="style.css" />
  <!-- Three.js for 3D visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <!-- Demo mode for static hosting -->
  <script>
    // Check if we're in demo mode (static hosting like Netlify)
    window.DEMO_MODE = true; // Set to true for testing demo mode
  </script>
</head>
<body>
  <header>
    <div class="nav-bg-pazzaz"></div>    <nav class="main-nav glass-nav" role="navigation" aria-label="Main navigation">
      <a href="index.html" aria-current="page">Home</a>
      <a href="about.html">About</a>
      <a href="order.html">Elevon Maps</a>
    </nav>
  </header>
  <main>
    <section class="hero">
      <div class="hero-text">        <h1>Westley Kleinman</h1>
        <div class="accent-bar"></div>
        <div class="hero-tagline">Engineer, Designer & Competitive Cyclist</div>
        <a href="about.html" class="cta-button">Learn About Me</a>
      </div>      <div class="hero-img-wrapper">
        <img src="images/headshot.png" alt="Westley Kleinman" class="hero-img" />
      </div>
    </section>

    <!-- Features Section -->
    <section class="features-section">      <div class="features-content">        <h2>What I Do</h2>
        <p class="features-intro">
          Duke engineering student passionate about design, cycling, and creating meaningful projects. 
          Here's what I'm currently working on.
        </p>
          <div class="features-grid">
          <div class="feature-card">
            <div class="feature-image">
              <img src="images/trail_maps.jpg" alt="Custom 3D printed race trophy map" />
            </div>            <div class="feature-content">
              <h3>Elevon Maps</h3>
              <div class="accent-bar"></div>
              <p>
                Founder of custom 3D-printed trail map business. Creating personalized 
                topographic art from real elevation data for cyclists and race directors.
              </p>
            </div>
          </div>

          <div class="feature-card">
            <div class="feature-image">
              <img src="images/blender_model.png" alt="3D printed trail system map for shops and enthusiasts" />
            </div>            <div class="feature-content">
              <h3>Engineering Projects</h3>
              <div class="accent-bar"></div>
              <p>
                Duke University student pursuing Mechanical Engineering with focus on 
                design, manufacturing, and innovative problem-solving.
              </p>
            </div>
          </div>

          <div class="feature-card">
            <div class="feature-image">
              <img src="images/trail_maps.jpg" alt="High-precision topographic 3D map detail" />
            </div>            <div class="feature-content">
              <h3>Competitive Cycling</h3>
              <div class="accent-bar"></div>
              <p>
                Competitive cyclist with NICA Arkansas racing experience. 
                Passionate about the sport that inspired my mapping business.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Process Overview Section -->
    <section class="process-overview">
      <div class="process-container">
        <div class="process-text">          <h2>My Approach</h2>
          <div class="accent-bar"></div>
          <p class="process-description">
            I believe in combining engineering precision with creative design to solve real problems. 
            Whether it's developing new products, tackling coursework, or training for races, 
            I approach each challenge with curiosity and determination.
          </p>
          
          <div class="process-steps-list">
            <div class="step-item">
              <div class="step-number">01</div>
              <div class="step-text">
                <h4>Choose Your Trail</h4>
                <p>Select any trail, race course, or route you love</p>
              </div>
            </div>
            
            <div class="step-item">
              <div class="step-number">02</div>
              <div class="step-text">
                <h4>We Design & Print</h4>
                <p>Real elevation data meets advanced 3D printing technology</p>
              </div>
            </div>
            
            <div class="step-item">
              <div class="step-number">03</div>
              <div class="step-text">
                <h4>Delivered to You</h4>
                <p>Ready to display, gift, or award as a trophy</p>
              </div>
            </div>
          </div>
          
          <a href="order.html" class="cta-button">Start Your Custom Map</a>
        </div>
        <div class="process-visual">
          <div class="visual-slideshow">
            <div class="slideshow-container">
              <div class="slide active" data-step="1">
                <img src="images/trail_maps.jpg" alt="Choose your trail - trail selection" class="process-img" />
                <div class="slide-caption">Step 1: Choose Your Trail</div>
              </div>
              <div class="slide" data-step="2">
                <img src="images/blender_model.png" alt="3D modeling and design process" class="process-img" />
                <div class="slide-caption">Step 2: We Design & Print</div>
              </div>
              <div class="slide" data-step="3">
                <img src="images/trail_maps.jpg" alt="Finished maps ready for delivery" class="process-img" />
                <div class="slide-caption">Step 3: Delivered to You</div>
              </div>
            </div>
            <div class="slideshow-nav">
              <button class="nav-dot active" data-slide="1"></button>
              <button class="nav-dot" data-slide="2"></button>
              <button class="nav-dot" data-slide="3"></button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- GPX Upload and Preview Section -->
    <section class="gpx-preview-section">
      <div class="gpx-container">
        <div class="gpx-content">
          <h2>See Your Trail in 3D</h2>
          <div class="accent-bar"></div>
          <p class="gpx-intro">
            Upload your GPX file to see an instant 3D preview of what your custom Elevon map will look like. 
            Experience the elevation, distance, and terrain before you order.
          </p>
          
          <div class="gpx-upload-area">
            <!-- Demo Notice for Static Hosting -->
            <div class="demo-notice" id="demo-notice" style="background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; border: 2px solid #f59e0b;">
              <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">üöß Demo Mode</h4>
              <p style="margin: 0; color: #92400e; font-size: 0.9rem;">This is a preview version. Upload any GPX file to see a sample 3D trail visualization!</p>
            </div>
            
            <div class="upload-zone" id="upload-zone">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text">
                <h3>Drop your GPX file here</h3>
                <p>or <span class="upload-link">click to browse</span></p>
                <small>Supports .gpx files up to 16MB</small>
              </div>
              <input type="file" id="gpx-file-input" accept=".gpx" style="display: none;">
            </div>
            
            <div class="upload-progress" id="upload-progress" style="display: none;">
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <p class="progress-text" id="progress-text">Processing your trail...</p>
            </div>
          </div>
          
          <div class="trail-stats" id="trail-stats" style="display: none;">
            <h3>Trail Statistics</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value" id="distance-value">0</div>
                <div class="stat-label">Distance (km)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="elevation-value">0</div>
                <div class="stat-label">Elevation Gain (m)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="points-value">0</div>
                <div class="stat-label">Data Points</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="gpx-preview">
          <div class="preview-container" id="preview-container">
            <div class="preview-placeholder" id="preview-placeholder">
              <div class="placeholder-icon">üèîÔ∏è</div>
              <h3>Your 3D Preview Will Appear Here</h3>
              <p>Upload a GPX file to see your trail rendered in beautiful 3D</p>
            </div>
            <canvas id="trail-canvas" style="display: none;"></canvas>
          </div>
          <div class="preview-controls" id="preview-controls" style="display: none;">
            <button class="control-btn" id="rotate-btn">üîÑ Auto Rotate</button>
            <button class="control-btn" id="reset-view-btn">üéØ Reset View</button>
            <div class="view-mode-toggle">
              <button class="mode-btn active" data-mode="3d">3D</button>
              <button class="mode-btn" data-mode="topdown">Top View</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Final Call-to-Action Section -->
    <section class="final-cta">
      <div class="cta-content">
        <h2>Ready to Turn Your Trail Into Art?</h2>
        <p>
          Join race directors and cycling enthusiasts who trust Elevon to create lasting memories of their favorite places. 
          Every map tells a story‚Äîwhat's yours?
        </p>
        <a href="order.html" class="cta-button cta-large">Start Your Custom Map</a>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Elevon. All rights reserved.</p>
  </footer>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const slides = document.querySelectorAll('.slide');
      const navDots = document.querySelectorAll('.nav-dot');
      const stepItems = document.querySelectorAll('.step-item');
      let currentSlide = 0;
      let slideInterval;

      // Check if elements exist before proceeding
      if (slides.length === 0 || navDots.length === 0 || stepItems.length === 0) {
        console.warn('Process overview elements not found');
        return;
      }

      function showSlide(index) {
        // Validate index
        if (index < 0 || index >= slides.length) {
          console.warn('Invalid slide index:', index);
          return;
        }
        
        // Remove active class from all slides, dots, and steps
        slides.forEach(slide => slide.classList.remove('active'));
        navDots.forEach(dot => dot.classList.remove('active'));
        stepItems.forEach(step => step.classList.remove('active'));
        
        // Add active class to current slide, dot, and step
        slides[index].classList.add('active');
        navDots[index].classList.add('active');
        stepItems[index].classList.add('active');
        
        currentSlide = index;
      }

      function nextSlide() {
        const next = (currentSlide + 1) % slides.length;
        showSlide(next);
      }      function startAutoSlide() {
        // Clear any existing interval
        if (slideInterval) {
          clearInterval(slideInterval);
        }
        slideInterval = setInterval(nextSlide, 3000); // Change slide every 3 seconds
      }

      function stopAutoSlide() {
        if (slideInterval) {
          clearInterval(slideInterval);
          slideInterval = null;
        }
      }// Add click listeners to navigation dots
      navDots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          showSlide(index);
          stopAutoSlide();
          setTimeout(startAutoSlide, 5000); // Restart auto-slide after 5 seconds
        });
      });
      
      // Add click listeners to step items
      stepItems.forEach((step, index) => {
        step.addEventListener('click', () => {
          showSlide(index);
          stopAutoSlide();
          setTimeout(startAutoSlide, 5000); // Restart auto-slide after 5 seconds
        });
      });
        // Add hover listeners to pause auto-slide
      const slideshow = document.querySelector('.visual-slideshow');
      if (slideshow) {
        slideshow.addEventListener('mouseenter', stopAutoSlide);
        slideshow.addEventListener('mouseleave', startAutoSlide);
      } else {
        console.warn('Visual slideshow element not found');
      }
        // Initialize first slide and start auto-slide
      showSlide(0);
      startAutoSlide();
      
      // Pause slideshow when page is not visible to save resources
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopAutoSlide();
        } else {
          startAutoSlide();
        }
      });
    });

    // Enhanced theme management system
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      // Use saved theme, or fall back to system preference
      const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
      
      // Apply theme to document root
      document.documentElement.setAttribute('data-theme', theme);
      
      return theme;
    }

    // Listen for system theme changes
    function setupThemeListener() {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      
      mediaQuery.addEventListener('change', (e) => {
        // Only auto-switch if user hasn't manually set a preference
        if (!localStorage.getItem('theme')) {
          const newTheme = e.matches ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
        }
      });
    }

    // Initialize theme system
    initializeTheme();
    setupThemeListener();

    // ============================================
    // GPX UPLOAD AND 3D PREVIEW FUNCTIONALITY
    // ============================================
    
    // Initialize GPX upload functionality
    initializeGPXUpload();
    
    function initializeGPXUpload() {
      console.log('Initializing GPX upload functionality...');
      
      const uploadZone = document.getElementById('upload-zone');
      const fileInput = document.getElementById('gpx-file-input');
      const uploadProgress = document.getElementById('upload-progress');
      const trailStats = document.getElementById('trail-stats');
      const previewContainer = document.getElementById('preview-container');
      const previewPlaceholder = document.getElementById('preview-placeholder');
      const trailCanvas = document.getElementById('trail-canvas');
      const previewControls = document.getElementById('preview-controls');
      
      console.log('Elements found:', {
        uploadZone: !!uploadZone,
        fileInput: !!fileInput,
        uploadProgress: !!uploadProgress,
        trailStats: !!trailStats,
        previewContainer: !!previewContainer,
        previewPlaceholder: !!previewPlaceholder,
        trailCanvas: !!trailCanvas,
        previewControls: !!previewControls
      });
      
      if (!uploadZone || !fileInput) {
        console.error('GPX upload elements not found!');
        return;
      }
      
      // Demo trail data for when backend is not available
      const demoTrailData = {
        points: [
          [0.1, 0.1, 0.2], [0.15, 0.12, 0.25], [0.2, 0.15, 0.3], [0.25, 0.18, 0.35],
          [0.3, 0.22, 0.4], [0.35, 0.25, 0.45], [0.4, 0.28, 0.5], [0.45, 0.32, 0.55],
          [0.5, 0.35, 0.6], [0.55, 0.38, 0.65], [0.6, 0.42, 0.7], [0.65, 0.45, 0.75],
          [0.7, 0.48, 0.8], [0.75, 0.52, 0.85], [0.8, 0.55, 0.9], [0.85, 0.58, 0.95],
          [0.9, 0.62, 1.0]
        ],
        stats: {
          total_points: 17,
          distance_km: 2.3,
          elevation_gain: 380
        }
      };
      
      let currentTrailData = null;
      let renderer = null;
      let scene = null;
      let camera = null;
      let controls = null;
      let animationId = null;
      
      // File upload handling
      uploadZone.addEventListener('click', function() {
        console.log('Upload zone clicked');
        fileInput.click();
      });
      
      uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });
      
      uploadZone.addEventListener('dragleave', function() {
        uploadZone.classList.remove('dragover');
      });
      
      uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });
      
      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });
      
      function handleFileUpload(file) {
        console.log('File upload started:', file.name);
        
        if (!file.name.toLowerCase().endsWith('.gpx')) {
          showError('Please upload a .gpx file');
          return;
        }
        
        if (file.size > 16 * 1024 * 1024) {
          showError('File size must be less than 16MB');
          return;
        }
        
        // Show progress
        uploadZone.style.display = 'none';
        uploadProgress.style.display = 'block';
        
        // Simulate progress for user feedback
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        
        let progress = 0;
        const progressInterval = setInterval(function() {
          progress += Math.random() * 30;
          if (progress > 90) {
            clearInterval(progressInterval);
            progress = 90;
          }
          progressFill.style.width = progress + '%';
        }, 100);
        
        // Check if we have backend or use demo mode
        if (window.DEMO_MODE) {
          console.log('Using demo mode');
          // Demo mode - show sample data
          setTimeout(function() {
            clearInterval(progressInterval);
            progressFill.style.width = '100%';
            
            currentTrailData = demoTrailData;
            displayTrailStats(demoTrailData.stats);
            create3DPreview(demoTrailData);
            
            setTimeout(function() {
              uploadProgress.style.display = 'none';
              trailStats.style.display = 'block';
              previewPlaceholder.style.display = 'none';
              trailCanvas.style.display = 'block';
              previewControls.style.display = 'flex';
            }, 500);
          }, 2000);
        } else {
          console.log('Trying backend upload');
          // Try backend upload
          const formData = new FormData();
          formData.append('gpx_file', file);
          
          fetch('/upload_gpx', {
            method: 'POST',
            body: formData
          })
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            clearInterval(progressInterval);
            progressFill.style.width = '100%';
            
            if (data.success) {
              currentTrailData = data.preview_data;
              displayTrailStats(data.preview_data.stats);
              create3DPreview(data.preview_data);
              
              setTimeout(function() {
                uploadProgress.style.display = 'none';
                trailStats.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                trailCanvas.style.display = 'block';
                previewControls.style.display = 'flex';
              }, 500);
            } else {
              showError(data.error || 'Failed to process GPX file');
            }
          })
          .catch(function(error) {
            console.log('Backend not available, switching to demo mode:', error);
            clearInterval(progressInterval);
            
            // Fallback to demo mode
            currentTrailData = demoTrailData;
            displayTrailStats(demoTrailData.stats);
            create3DPreview(demoTrailData);
            
            setTimeout(function() {
              uploadProgress.style.display = 'none';
              trailStats.style.display = 'block';
              previewPlaceholder.style.display = 'none';
              trailCanvas.style.display = 'block';
              previewControls.style.display = 'flex';
            }, 500);
          });
        }
      }
      
      function displayTrailStats(stats) {
        document.getElementById('distance-value').textContent = stats.distance_km;
        document.getElementById('elevation-value').textContent = stats.elevation_gain;
        document.getElementById('points-value').textContent = stats.total_points.toLocaleString();
      }
      
      function showError(message) {
        uploadProgress.style.display = 'none';
        uploadZone.style.display = 'block';
        alert(message);
      }
      
      // 3D Visualization using Three.js
      function create3DPreview(trailData) {
        console.log('Creating 3D preview...', trailData);
        
        if (!window.THREE) {
          console.log('Three.js not available, using 2D fallback');
          create2DPreview(trailData);
          return;
        }
        
        // Clear any existing scene
        if (renderer) {
          renderer.dispose();
        }
        
        // Initialize Three.js scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf8f9fa);
        
        // Camera setup
        camera = new THREE.PerspectiveCamera(75, trailCanvas.offsetWidth / trailCanvas.offsetHeight, 0.1, 1000);
        camera.position.set(0.5, 1, 0.5);
        camera.lookAt(0.5, 0, 0.5);
        
        // Renderer setup
        renderer = new THREE.WebGLRenderer({ canvas: trailCanvas, antialias: true });
        renderer.setSize(trailCanvas.offsetWidth, trailCanvas.offsetHeight);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 0.5);
        scene.add(directionalLight);
        
        // Create trail geometry
        createTrailMesh(trailData.points);
        
        // Add controls if available
        if (window.THREE.OrbitControls) {
          controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.1;
        }
        
        // Start animation loop
        animate();
        
        // Setup control buttons
        setupPreviewControls();
      }
      
      function createTrailMesh(points) {
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        
        points.forEach(function(point) {
          positions.push(point[0], point[2], point[1]);
        });
        
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        
        const material = new THREE.LineBasicMaterial({ 
          color: 0x2d5a3d, 
          linewidth: 3 
        });
        
        const line = new THREE.Line(geometry, material);
        scene.add(line);
        
        // Add markers
        addTrailMarkers(points);
      }
      
      function addTrailMarkers(points) {
        if (points.length > 0) {
          // Start marker
          const startGeometry = new THREE.SphereGeometry(0.02, 8, 6);
          const startMaterial = new THREE.MeshLambertMaterial({ color: 0x2d5a3d });
          const startMarker = new THREE.Mesh(startGeometry, startMaterial);
          startMarker.position.set(points[0][0], points[0][2] + 0.02, points[0][1]);
          scene.add(startMarker);
          
          // End marker
          const endGeometry = new THREE.SphereGeometry(0.02, 8, 6);
          const endMaterial = new THREE.MeshLambertMaterial({ color: 0xd4621a });
          const endMarker = new THREE.Mesh(endGeometry, endMaterial);
          const lastPoint = points[points.length - 1];
          endMarker.position.set(lastPoint[0], lastPoint[2] + 0.02, lastPoint[1]);
          scene.add(endMarker);
        }
      }
      
      function animate() {
        animationId = requestAnimationFrame(animate);
        
        if (controls) {
          controls.update();
        }
        
        if (renderer && scene && camera) {
          renderer.render(scene, camera);
        }
      }
      
      function setupPreviewControls() {
        const rotateBtn = document.getElementById('rotate-btn');
        const resetViewBtn = document.getElementById('reset-view-btn');
        const modeButtons = document.querySelectorAll('.mode-btn');
        
        let autoRotate = false;
        
        if (rotateBtn) {
          rotateBtn.addEventListener('click', function() {
            autoRotate = !autoRotate;
            if (controls) {
              controls.autoRotate = autoRotate;
              rotateBtn.textContent = autoRotate ? '‚è∏Ô∏è Stop Rotate' : 'üîÑ Auto Rotate';
            }
          });
        }
        
        if (resetViewBtn) {
          resetViewBtn.addEventListener('click', function() {
            if (camera && controls) {
              camera.position.set(0.5, 1, 0.5);
              camera.lookAt(0.5, 0, 0.5);
              controls.reset();
            }
          });
        }
        
        modeButtons.forEach(function(btn) {
          btn.addEventListener('click', function() {
            modeButtons.forEach(function(b) {
              b.classList.remove('active');
            });
            btn.classList.add('active');
            
            if (btn.dataset.mode === 'topdown' && camera) {
              camera.position.set(0.5, 2, 0.5);
              camera.lookAt(0.5, 0, 0.5);
            } else if (btn.dataset.mode === '3d' && camera) {
              camera.position.set(0.5, 1, 0.5);
              camera.lookAt(0.5, 0, 0.5);
            }
          });
        });
      }
      
      // Fallback 2D preview
      function create2DPreview(trailData) {
        console.log('Creating 2D preview...');
        const ctx = trailCanvas.getContext('2d');
        const width = trailCanvas.offsetWidth;
        const height = trailCanvas.offsetHeight;
        
        trailCanvas.width = width;
        trailCanvas.height = height;
        
        // Clear canvas
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, width, height);
        
        const points = trailData.points;
        if (points.length < 2) return;
        
        // Draw trail
        ctx.strokeStyle = '#2d5a3d';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(points[0][0] * width, points[0][1] * height);
        
        for (let i = 1; i < points.length; i++) {
          ctx.lineTo(points[i][0] * width, points[i][1] * height);
        }
        
        ctx.stroke();
        
        // Draw markers
        ctx.fillStyle = '#2d5a3d';
        ctx.beginPath();
        ctx.arc(points[0][0] * width, points[0][1] * height, 6, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#d4621a';
        ctx.beginPath();
        const lastPoint = points[points.length - 1];
        ctx.arc(lastPoint[0] * width, lastPoint[1] * height, 6, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (renderer && camera) {
          camera.aspect = trailCanvas.offsetWidth / trailCanvas.offsetHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(trailCanvas.offsetWidth, trailCanvas.offsetHeight);
        }
      });
      
      // Cleanup
      window.addEventListener('beforeunload', function() {
        if (animationId) {
          cancelAnimationFrame(animationId);
        }
        if (renderer) {
          renderer.dispose();
        }
      });
    }
        ctx.fillRect(0, 0, width, height);
        
        // Draw trail
        const points = trailData.points;
        if (points.length < 2) return;
        
        ctx.strokeStyle = '#2d5a3d';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(points[0][0] * width, points[0][1] * height);
        
        for (let i = 1; i < points.length; i++) {
          ctx.lineTo(points[i][0] * width, points[i][1] * height);
        }
        
        ctx.stroke();
        
        // Draw start marker
        ctx.fillStyle = '#2d5a3d';
        ctx.beginPath();
        ctx.arc(points[0][0] * width, points[0][1] * height, 6, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw end marker
        ctx.fillStyle = '#d4621a';
        ctx.beginPath();
        const lastPoint = points[points.length - 1];
        ctx.arc(lastPoint[0] * width, lastPoint[1] * height, 6, 0, Math.PI * 2);
        ctx.fill();
        
        // Add elevation visualization using color gradients
        if (points.length > 2) {
          for (let i = 0; i < points.length - 1; i++) {
            const elevationRatio = points[i][2]; // z is elevation
            const hue = 120 * (1 - elevationRatio); // Green to red
            ctx.strokeStyle = `hsl(${hue}, 70%, 50%)`;
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(points[i][0] * width, points[i][1] * height);
            ctx.lineTo(points[i + 1][0] * width, points[i + 1][1] * height);
            ctx.stroke();
          }
        }
      }
  </script>
</body>
</html>