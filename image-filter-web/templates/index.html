<!DOCTYPE html>
<html>
<head>
    <title>Image Color Filter</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="header-bar">
        <a href="/" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
            <img src="{{ url_for('static', filename='images/elevon_logo.png') }}" alt="Elevon Logo" class="logo-img" style="max-width:60px;vertical-align:middle;box-shadow:none;">
            <h1 class="main-title" style="margin:0;">Image Color Filter</h1>
        </a>
    </div>
    <form method="post" enctype="multipart/form-data" class="main-form modern-form">
        <label class="main-label">Select PNG image:</label>
        <input type="file" name="image" id="image" accept="image/png" required onchange="fetchTopColors()" class="file-input"><br>
        <hr class="divider">
        <div class="outputs-container modern-outputs">
        {% for out in range(3) %}
        <div class="output-block modern-output-block">
            <div class="output-header">
                <span class="output-number">Output {{out+1}}</span>
                <input type="text" name="filename_{{out}}" placeholder="output{{out+1}}.png" class="filename-input modern-filename-input" aria-label="Output {{out+1}} filename">
            </div>
            <div class="color-slots">
            {% for slot in range(3) %}
            <div class="color-row modern-color-row">
                <span class="color-slot-label">Color {{slot+1}}:</span>
                <span id="color-preview-{{out}}-{{slot}}" class="color-swatch modern-color-swatch"></span>
                <input type="number" name="r_{{out}}_{{slot}}" id="r_{{out}}_{{slot}}" min="0" max="255" placeholder="R" class="color-input modern-color-input" aria-label="Red">
                <input type="number" name="g_{{out}}_{{slot}}" id="g_{{out}}_{{slot}}" min="0" max="255" placeholder="G" class="color-input modern-color-input" aria-label="Green">
                <input type="number" name="b_{{out}}_{{slot}}" id="b_{{out}}_{{slot}}" min="0" max="255" placeholder="B" class="color-input modern-color-input" aria-label="Blue">
                <input type="number" name="t_{{out}}_{{slot}}" id="t_{{out}}_{{slot}}" min="0" max="442" step="1" placeholder="Tolerance" class="tol-input modern-tol-input" aria-label="Tolerance">
                <span id="color-label-{{out}}-{{slot}}" class="modern-color-label"></span>
                <button type="button" class="apply-btn modern-apply-btn" onclick="openApplyDialog({{out}},{{slot}})">ðŸŽ¨ Pick</button>
            </div>
            {% endfor %}
            </div>
        </div>
        {% endfor %}
        </div>
        <button type="submit" class="main-btn modern-main-btn">Download Outputs</button>
    </form>
    <!-- Modal for picking top color -->
    <div id="apply-modal" class="modal modern-modal" style="display:none; align-items: center; justify-content: center;">
        <div class="modal-content modern-modal-content" tabindex="-1">
            <span class="close modern-close" onclick="closeApplyDialog()" style="position:absolute; top:10px; right:18px; cursor:pointer;">&times;</span>
            <h3 style="margin-top:0;">Pick a Top Color</h3>
            <div id="modal-top-colors"></div>
        </div>
    </div>
    <script>
let topColors = [];
let applyTarget = {out: 0, slot: 0};
function setTopColors(colors) {
    topColors = colors;
}
function openApplyDialog(out, slot) {
    applyTarget = {out, slot};
    const modal = document.getElementById('apply-modal');
    const modalColors = document.getElementById('modal-top-colors');
    modalColors.innerHTML = '';
    if (!topColors.length) {
        modalColors.innerHTML = '<i>No top colors detected. Please select an image first.</i>';
    } else {
        topColors.forEach((color, idx) => {
            const colorRow = document.createElement('div');
            colorRow.style.display = 'flex';
            colorRow.style.alignItems = 'center';
            colorRow.style.marginBottom = '8px';
            colorRow.style.justifyContent = 'space-between';
            // Color swatch preview
            const swatch = document.createElement('span');
            swatch.className = 'color-swatch modern-color-swatch';
            swatch.style.background = `rgb(${color[0]},${color[1]},${color[2]})`;
            swatch.style.marginRight = '10px';
            // RGB label
            const rgbLabel = document.createElement('span');
            rgbLabel.textContent = `RGB(${color[0]}, ${color[1]}, ${color[2]})`;
            rgbLabel.style.fontWeight = '500';
            rgbLabel.style.marginRight = '10px';
            // Keep button
            const keepBtn = document.createElement('button');
            keepBtn.className = 'apply-btn modern-apply-btn';
            keepBtn.style.background = `rgba(${color[0]},${color[1]},${color[2]},0.85)`;
            keepBtn.style.color = '#fff';
            keepBtn.style.margin = '5px 0 5px 8px';
            keepBtn.textContent = 'Keep';
            keepBtn.type = 'button';
            keepBtn.onclick = function() { applyColorToEntry(color, applyTarget.out, applyTarget.slot); closeApplyDialog(); };
            colorRow.appendChild(swatch);
            colorRow.appendChild(rgbLabel);
            colorRow.appendChild(keepBtn);
            modalColors.appendChild(colorRow);
        });
        // Add Cancel button
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'apply-btn modern-apply-btn';
        cancelBtn.style.background = '#888';
        cancelBtn.style.margin = '5px';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = closeApplyDialog;
        modalColors.appendChild(cancelBtn);
    }
    // Show modal as a centered flex popup
    modal.style.display = 'flex';
    setTimeout(() => {
        document.querySelector('.modal-content').focus();
    }, 100);
}
function closeApplyDialog() {
    document.getElementById('apply-modal').style.display = 'none';
}
function applyColorToEntry(color, outputIdx, colorIdx) {
    document.getElementById(`r_${outputIdx}_${colorIdx}`).value = color[0];
    document.getElementById(`g_${outputIdx}_${colorIdx}`).value = color[1];
    document.getElementById(`b_${outputIdx}_${colorIdx}`).value = color[2];
    const previewId = `color-preview-${outputIdx}-${colorIdx}`;
    const labelId = `color-label-${outputIdx}-${colorIdx}`;
    const swatch = document.getElementById(previewId);
    const label = document.getElementById(labelId);
    if (swatch) {
        swatch.style.background = `rgb(${color[0]},${color[1]},${color[2]})`;
    }
    if (label) {
        label.textContent = `RGB(${color[0]}, ${color[1]}, ${color[2]})`;
    }
}
function fetchTopColors() {
    const fileInput = document.getElementById('image');
    if (!fileInput.files.length) return;
    const formData = new FormData();
    formData.append('image', fileInput.files[0]);
    fetch('/top_colors', { method: 'POST', body: formData })
        .then(function(resp) { return resp.json(); })
        .then(function(data) { setTopColors(data.top_colors); })
        .catch(function() { setTopColors([]); });
}
document.addEventListener('input', function(e) {
    const id = e.target.id;
    const rgbMatch = id && id.match(/^([rgb])_(\d+)_(\d+)$/);
    if (rgbMatch) {
        const [, channel, out, slot] = rgbMatch;
        const r = parseInt(document.getElementById(`r_${out}_${slot}`).value) || 0;
        const g = parseInt(document.getElementById(`g_${out}_${slot}`).value) || 0;
        const b = parseInt(document.getElementById(`b_${out}_${slot}`).value) || 0;
        const swatch = document.getElementById(`color-preview-${out}-${slot}`);
        const label = document.getElementById(`color-label-${out}-${slot}`);
        if (swatch) swatch.style.background = `rgb(${r},${g},${b})`;
        if (label) label.textContent = `RGB(${r}, ${g}, ${b})`;
    }
});
window.onclick = function(event) {
    const modal = document.getElementById('apply-modal');
    if (event.target == modal) {
        closeApplyDialog();
    }
}
    </script>
</body>
</html>
