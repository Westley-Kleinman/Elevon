<!DOCTYPE html>
<html lang="en">
<head>
    <title>Image Color Filter | Elevon</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* All custom styles moved to static/style.css for a sleek, modern, and easy-to-use UI. */
    </style>
</head>
<body>
    <div class="header-bar">
        <img src="/static/images/elevon_logo.png" alt="Elevon Logo" class="logo-img">
        <h1 class="main-title">Elevon Image Color Filter</h1>
    </div>
    <form method="post" enctype="multipart/form-data" class="main-form" onsubmit="return handleFormSubmit(event)">
        <div class="form-section">
            <label class="main-label">Select PNG image:</label>
            <input type="file" name="image" id="image" accept="image/png" required onchange="extractTopColorsFrontend()" class="file-input">
        </div>
        <hr class="divider">
        <div class="outputs-container">
        {% for out in range(3) %}
        <div class="output-block" id="output-block-{{out}}">
            <div class="output-header">
                <span class="output-number">Output {{out+1}}</span>
                <input type="text" name="filename_{{out}}" placeholder="output{{out+1}}.png" class="filename-input" aria-label="Output {{out+1}} filename">
            </div>
            <div class="color-slots">
            {% for slot in range(3) %}
            <div class="color-row">
                <span class="color-slot-label">Color {{slot+1}}:</span>
                <span id="color-preview-{{out}}-{{slot}}" class="color-swatch"></span>
                <input type="number" name="r_{{out}}_{{slot}}" id="r_{{out}}_{{slot}}" min="0" max="255" placeholder="R" class="color-input" aria-label="Red" oninput="updateColorPreview({{out}},{{slot}})">
                <input type="number" name="g_{{out}}_{{slot}}" id="g_{{out}}_{{slot}}" min="0" max="255" placeholder="G" class="color-input" aria-label="Green" oninput="updateColorPreview({{out}},{{slot}})">
                <input type="number" name="b_{{out}}_{{slot}}" id="b_{{out}}_{{slot}}" min="0" max="255" placeholder="B" class="color-input" aria-label="Blue" oninput="updateColorPreview({{out}},{{slot}})">
                <input type="number" name="t_{{out}}_{{slot}}" id="t_{{out}}_{{slot}}" min="0" max="442" step="1" placeholder="Tolerance" class="tol-input" aria-label="Tolerance">
                <span id="color-label-{{out}}-{{slot}}" class="color-label" style="font-size: 0.98rem; color: #2e3a4a; font-weight: 500; min-width: 120px; display: inline-block;"></span>
                <button type="button" class="apply-btn" onclick="openApplyDialog('{{ out }}', '{{ slot }}')">ðŸŽ¨ Pick</button>
            </div>
            {% endfor %}
            </div>
        </div>
        {% endfor %}
        </div>
        <button type="submit" class="main-btn">Download Outputs</button>
    </form>
    <!-- Modal for picking top color -->
    <div id="apply-modal" class="modal">
        <div class="modal-content" tabindex="-1">
            <span class="close" onclick="closeApplyDialog()">&times;</span>
            <h3 style="margin-top:0; color:#2e3a4a; font-size:1.3rem; font-weight:900;">Pick a Top Color</h3>
            <div id="modal-top-colors"></div>
        </div>
    </div>
    <script>
let topColors = [];
let applyTarget = {out: 0, slot: 0};
function setTopColors(colors) {
    topColors = colors;
}
function extractTopColorsFrontend() {
    const fileInput = document.getElementById('image');
    if (!fileInput.files.length) return;
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new window.Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const data = ctx.getImageData(0, 0, img.width, img.height).data;
            const colorCounts = {};
            for (let i = 0; i < data.length; i += 4) {
                if (data[i+3] === 0) continue;
                const key = data[i] + ',' + data[i+1] + ',' + data[i+2];
                colorCounts[key] = (colorCounts[key] || 0) + 1;
            }
            const top = Object.entries(colorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([k, v]) => k.split(',').map(Number));
            setTopColors(top);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}
function openApplyDialog(out, slot) {
    applyTarget = {out, slot};
    const modal = document.getElementById('apply-modal');
    const modalColors = document.getElementById('modal-top-colors');
    modalColors.innerHTML = '';
    if (!topColors.length) {
        modalColors.innerHTML = '<i>No top colors detected. Please select an image first.</i>';
    } else {
        topColors.forEach(function(color, idx) {
            const colorRow = document.createElement('div');
            colorRow.style.display = 'flex';
            colorRow.style.alignItems = 'center';
            colorRow.style.marginBottom = '8px';
            colorRow.style.justifyContent = 'space-between';
            const swatch = document.createElement('span');
            swatch.className = 'color-swatch modern-color-swatch';
            swatch.style.background = 'rgb(' + color[0] + ',' + color[1] + ',' + color[2] + ')';
            swatch.style.marginRight = '10px';
            const rgbLabel = document.createElement('span');
            rgbLabel.textContent = 'RGB(' + color[0] + ', ' + color[1] + ', ' + color[2] + ')';
            rgbLabel.style.fontWeight = '500';
            rgbLabel.style.marginRight = '10px';
            const keepBtn = document.createElement('button');
            keepBtn.className = 'apply-btn modern-apply-btn';
            keepBtn.style.background = 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',0.85)';
            keepBtn.style.color = '#fff';
            keepBtn.style.margin = '5px 0 5px 8px';
            keepBtn.textContent = 'Keep';
            keepBtn.type = 'button';
            keepBtn.onclick = function() {
                applyColorToEntry(color, out, slot);
                highlightOutputBlock(out);
                closeApplyDialog();
            };
            colorRow.appendChild(swatch);
            colorRow.appendChild(rgbLabel);
            colorRow.appendChild(keepBtn);
            modalColors.appendChild(colorRow);
        });
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'apply-btn modern-apply-btn';
        cancelBtn.style.background = '#888';
        cancelBtn.style.margin = '5px';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = closeApplyDialog;
        modalColors.appendChild(cancelBtn);
    }
    modal.style.display = 'flex';
    setTimeout(function() {
        document.querySelector('.modal-content').focus();
    }, 100);
}
function closeApplyDialog() {
    document.getElementById('apply-modal').style.display = 'none';
}
function setColorInputsAndPreview(out, slot, r, g, b) {
    // Set the input values and trigger input events for live update
    const rInput = document.getElementById('r_' + out + '_' + slot);
    const gInput = document.getElementById('g_' + out + '_' + slot);
    const bInput = document.getElementById('b_' + out + '_' + slot);
    if (rInput && gInput && bInput) {
        rInput.value = r;
        gInput.value = g;
        bInput.value = b;
        // Manually trigger input events so listeners update the preview
        rInput.dispatchEvent(new Event('input', { bubbles: true }));
        gInput.dispatchEvent(new Event('input', { bubbles: true }));
        bInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}
function applyColorToEntry(color, outputIdx, colorIdx) {
    setColorInputsAndPreview(outputIdx, colorIdx, color[0], color[1], color[2]);
    highlightOutputBlock(outputIdx);
    closeApplyDialog();
}
function updateColorPreview(out, slot) {
    var r = document.getElementById('r_' + out + '_' + slot).value;
    var g = document.getElementById('g_' + out + '_' + slot).value;
    var b = document.getElementById('b_' + out + '_' + slot).value;
    var swatch = document.getElementById('color-preview-' + out + '-' + slot);
    var label = document.getElementById('color-label-' + out + '-' + slot);
    if (r !== '' && g !== '' && b !== '') {
        r = Math.max(0, Math.min(255, parseInt(r)));
        g = Math.max(0, Math.min(255, parseInt(g)));
        b = Math.max(0, Math.min(255, parseInt(b)));
        if (swatch) {
            swatch.style.background = 'rgb(' + r + ',' + g + ',' + b + ')';
            swatch.style.border = '2.5px solid #2e3a4a';
            swatch.style.boxShadow = '0 0 0 2px #2e3a4a';
        }
        if (label) label.textContent = 'RGB(' + r + ', ' + g + ', ' + b + ')';
    } else {
        if (swatch) {
            swatch.style.background = '#eee';
            swatch.style.border = '2px solid #e5e5e5';
            swatch.style.boxShadow = 'none';
        }
        if (label) label.textContent = '';
    }
}
// On page load, initialize all color previews to match any prefilled values
window.addEventListener('DOMContentLoaded', function() {
    for (let out = 0; out < 3; out++) {
        for (let slot = 0; slot < 3; slot++) {
            updateColorPreview(out, slot);
            // Add listeners for all R/G/B fields
            ['r','g','b'].forEach(function(ch) {
                var el = document.getElementById(ch + '_' + out + '_' + slot);
                if (el) {
                    el.addEventListener('input', function() { updateColorPreview(out, slot); });
                }
            });
        }
    }
});
document.addEventListener('input', function(e) {
    var id = e.target.id;
    var rgbMatch = id && id.match(/^([rgb])_(\d+)_(\d+)$/);
    if (rgbMatch) {
        var out = rgbMatch[2];
        var slot = rgbMatch[3];
        updateColorPreview(out, slot);
    }
});
function highlightOutputBlock(outIdx) {
    for (let i = 0; i < 3; i++) {
        const block = document.getElementById('output-block-' + i);
        if (block) {
            if (i === outIdx) {
                block.classList.add('selected');
            } else {
                block.classList.remove('selected');
            }
        }
    }
}
function handleFormSubmit(e) {
    // Prevent backend upload, do all processing in browser
    e.preventDefault();
    const fileInput = document.getElementById('image');
    if (!fileInput.files.length) {
        alert('Please select an image.');
        return false;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(ev) {
        const img = new window.Image();
        img.onload = function() {
            for (let out = 0; out < 3; out++) {
                const filename = document.querySelector(`[name=filename_${out}]`).value.trim() || `output${out+1}.png`;
                let colorTols = [];
                for (let slot = 0; slot < 3; slot++) {
                    const r = document.getElementById(`r_${out}_${slot}`).value;
                    const g = document.getElementById(`g_${out}_${slot}`).value;
                    const b = document.getElementById(`b_${out}_${slot}`).value;
                    const t = document.getElementById(`t_${out}_${slot}`).value;
                    if (r !== '' && g !== '' && b !== '' && t !== '') {
                        colorTols.push({r: +r, g: +g, b: +b, tol: +t});
                    }
                }
                if (colorTols.length > 0) {
                    // Create canvas and process
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, img.width, img.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        let keep = false;
                        for (const c of colorTols) {
                            const dr = data[i] - c.r;
                            const dg = data[i+1] - c.g;
                            const db = data[i+2] - c.b;
                            const dist = Math.sqrt(dr*dr + dg*dg + db*db);
                            if (dist <= c.tol) {
                                keep = true;
                                break;
                            }
                        }
                        if (!keep) {
                            data[i] = 255; data[i+1] = 255; data[i+2] = 255; // white
                        } else {
                            data[i] = 0; data[i+1] = 0; data[i+2] = 0; // black
                        }
                        data[i+3] = 255;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    // Download result
                    const link = document.createElement('a');
                    link.download = filename.endsWith('.png') ? filename : filename + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }
            }
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    return false;
}
    </script>
</body>
</html>